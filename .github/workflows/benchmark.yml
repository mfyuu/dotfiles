name: Zsh Startup Benchmark

on:
  push:
    branches: [main]

permissions:
  actions: write
  deployments: write
  contents: write

jobs:
  benchmark:
    name: Zsh Startup Time
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21

      - name: Cache Nix store
        uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-
          gc-max-store-size-macos: 5G
          purge: true
          purge-prefixes: nix-${{ runner.os }}-
          purge-last-accessed: P7D
          purge-primary-key: never

      - name: Build home-manager generation
        id: build
        run: |
          HM_GEN=$(nix build --no-link --print-out-paths \
            '.#darwinConfigurations.M4Pro.config.home-manager.users.mfyuu.home.activationPackage')
          echo "hm_gen=$HM_GEN" >> "$GITHUB_OUTPUT"

      - name: Set up shell environment
        run: |
          HM_GEN="${{ steps.build.outputs.hm_gen }}"

          # Replace macOS default /etc/ files to match nix-darwin environment.
          # - /etc/zprofile: remove path_helper (slow PATH construction)
          # - /etc/zshrc: remove compinit/promptinit (nix-darwin sets enableGlobalCompInit=false)
          # - /etc/zshenv: keep Nix daemon setup for PATH
          # See hosts/common/default.nix:19-23
          sudo sh -c '
            echo "" > /etc/zprofile
            echo "" > /etc/zshrc
          '

          # Create /Users/mfyuu for HISTFILE (home-manager hardcodes home.homeDirectory)
          sudo mkdir -p /Users/mfyuu
          sudo chown "$(whoami)" /Users/mfyuu

          # Symlink user-level dotfiles
          ln -sf "$HM_GEN/home-files/.zshrc" ~/.zshrc
          ln -sf "$HM_GEN/home-files/.zshenv" ~/.zshenv
          ln -sf "$HM_GEN/home-files/.zprofile" ~/.zprofile

          # Symlink .config directories
          mkdir -p ~/.config
          for item in "$HM_GEN/home-files/.config/"*; do
            name=$(basename "$item")
            rm -rf "$HOME/.config/$name"
            ln -sf "$item" "$HOME/.config/$name"
          done

          # Add home-manager binaries to PATH
          export PATH="$HM_GEN/home-path/bin:$PATH"

          # Pre-populate sheldon cache (first run clones plugins via git)
          mkdir -p ~/.cache/sheldon
          sheldon lock
          sheldon source > ~/.cache/sheldon/sheldon.zsh
          readlink ~/.config/sheldon/plugins.toml > ~/.cache/sheldon/sheldon.zsh.lock

          # Warm up caches: cache_eval, zcompile (.zwc for sheldon.zsh)
          zsh -i -c exit

      - name: Disable git commit signing
        run: git config --global commit.gpgsign false

      - name: Debug environment
        run: |
          HM_GEN="${{ steps.build.outputs.hm_gen }}"
          export PATH="$HM_GEN/home-path/bin:$PATH"

          echo "=== /etc/zshenv ==="
          cat /etc/zshenv
          echo "=== /etc/zprofile ==="
          cat /etc/zprofile
          echo "=== /etc/zshrc ==="
          cat /etc/zshrc
          echo "=== ~/.zshenv (resolved) ==="
          cat "$(readlink ~/.zshenv)"
          echo "=== cache_eval files ==="
          ls -la ~/.cache/zsh/ 2>&1 || echo "no cache dir"
          echo "=== zcompile .zwc files ==="
          find ~/.cache -name "*.zwc" 2>/dev/null || echo "no .zwc files"
          echo "=== env vars ==="
          zsh -i -c 'echo "NIX_PROFILES=$NIX_PROFILES"; echo "PATH=$PATH"' 2>&1 | head -5
          echo "=== warmup timing ==="
          time zsh -i -c exit
          time zsh -i -c exit
          time zsh -i -c exit

      - name: Run benchmark
        run: |
          HM_GEN="${{ steps.build.outputs.hm_gen }}"
          export PATH="$HM_GEN/home-path/bin:$PATH"

          hyperfine \
            --warmup 5 \
            --runs 30 \
            --export-json bench-result.json \
            'zsh -i -c exit'

      - name: Convert to benchmark format
        run: bash .github/scripts/convert-hyperfine.sh bench-result.json benchmark-result.json

      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: Zsh Startup Time
          tool: customSmallerIsBetter
          output-file-path: benchmark-result.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          alert-threshold: "150%"
          comment-on-alert: true
          comment-always: true
          fail-on-alert: true
          summary-always: true
          alert-comment-cc-users: "@mfyuu"
