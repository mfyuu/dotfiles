name: Zsh Startup Benchmark

on:
  push:
    branches: [main]

permissions:
  deployments: write
  contents: write

jobs:
  benchmark:
    name: Zsh Startup Time
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Build home-manager generation
        id: build
        run: |
          HM_GEN=$(nix build --no-link --print-out-paths \
            '.#darwinConfigurations.M4Pro.config.home-manager.users.mfyuu.home.activationPackage')
          echo "hm_gen=$HM_GEN" >> "$GITHUB_OUTPUT"

      - name: Set up shell environment
        run: |
          HM_GEN="${{ steps.build.outputs.hm_gen }}"

          # Symlink user-level dotfiles
          ln -sf "$HM_GEN/home-files/.zshrc" ~/.zshrc
          ln -sf "$HM_GEN/home-files/.zshenv" ~/.zshenv
          ln -sf "$HM_GEN/home-files/.zprofile" ~/.zprofile

          # Symlink .config directories
          mkdir -p ~/.config
          for item in "$HM_GEN/home-files/.config/"*; do
            name=$(basename "$item")
            rm -rf "$HOME/.config/$name"
            ln -sf "$item" "$HOME/.config/$name"
          done

          # Add home-manager binaries to PATH
          export PATH="$HM_GEN/home-path/bin:$PATH"

          # Pre-populate sheldon cache (first run clones plugins via git)
          mkdir -p ~/.cache/sheldon
          sheldon lock
          sheldon source > ~/.cache/sheldon/sheldon.zsh
          readlink ~/.config/sheldon/plugins.toml > ~/.cache/sheldon/sheldon.zsh.lock

      - name: Disable git commit signing
        run: git config --global commit.gpgsign false

      - name: Debug environment
        run: |
          HM_GEN="${{ steps.build.outputs.hm_gen }}"
          export PATH="$HM_GEN/home-path/bin:$PATH"

          echo "=== /etc/zshenv ==="
          cat /etc/zshenv 2>/dev/null || echo "(not found)"
          echo ""
          echo "=== /etc/zshrc ==="
          cat /etc/zshrc 2>/dev/null || echo "(not found)"
          echo ""
          echo "=== /etc/zprofile ==="
          cat /etc/zprofile 2>/dev/null || echo "(not found)"
          echo ""
          echo "=== cache_eval caches ==="
          ls -la ~/.cache/zsh/ 2>/dev/null || echo "(no cache dir)"
          echo ""
          echo "=== zsh startup trace (top 20 slowest) ==="
          zsh -i -c 'zprof' 2>/dev/null | head -20 || true
          echo ""
          echo "=== ZDOTDIR / NIX_PROFILES ==="
          zsh -i -c 'echo "ZDOTDIR=$ZDOTDIR"; echo "NIX_PROFILES=$NIX_PROFILES"' 2>/dev/null || true
          echo ""
          echo "=== benchmark: bare zsh (no user config) ==="
          hyperfine --warmup 3 --runs 10 'zsh --no-rcs -c exit'
          echo ""
          echo "=== benchmark: with /etc/ only (no user config) ==="
          hyperfine --warmup 3 --runs 10 'zsh --no-rcs -c "source /etc/zshenv 2>/dev/null; source /etc/zshrc 2>/dev/null; exit"'

      - name: Run benchmark
        run: |
          HM_GEN="${{ steps.build.outputs.hm_gen }}"
          export PATH="$HM_GEN/home-path/bin:$PATH"

          hyperfine \
            --warmup 5 \
            --runs 30 \
            --export-json bench-result.json \
            'zsh -i -c exit'

      - name: Convert to benchmark format
        run: bash .github/scripts/convert-hyperfine.sh bench-result.json benchmark-result.json

      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: Zsh Startup Time
          tool: customSmallerIsBetter
          output-file-path: benchmark-result.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          alert-threshold: "150%"
          comment-on-alert: true
          comment-always: true
          fail-on-alert: true
          summary-always: true
          alert-comment-cc-users: "@mfyuu"
